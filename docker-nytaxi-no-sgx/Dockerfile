FROM intelanalytics/bigdl-ppml-azure-occlum:2.1.0-SNAPSHOT as occlum

FROM apache/spark:v3.1.3 as ppml

ARG HTTP_PROXY_HOST
ARG HTTP_PROXY_PORT
ARG HTTPS_PROXY_HOST
ARG HTTPS_PROXY_PORT
ARG AZURE_BLOB_ACCOUNT_NAME
ARG AZURE_BLOB_CONTAINER_NAME
ARG AZURE_BLOB_RELATIVE_PATH
ARG AZURE_BLOB_SAS_TOKEN
ARG AZURE_SQL_AE_JDBC

ENV AZURE_BLOB_ACCOUNT_NAME=$AZURE_BLOB_ACCOUNT_NAME
ENV AZURE_BLOB_CONTAINER_NAME=$AZURE_BLOB_CONTAINER_NAME
ENV AZURE_BLOB_RELATIVE_PATH=$AZURE_BLOB_RELATIVE_PATH
ENV AZURE_BLOB_SAS_TOKEN=$AZURE_BLOB_SAS_TOKEN
ENV AZURE_SQL_AE_JDBC=$AZURE_SQL_AE_JDBC

ENV AZDCAP_DEBUG_LOG_LEVEL=fatal

COPY --from=occlum /opt/spark/ /opt/spark/
COPY --from=occlum /opt/libhadoop.so /opt/libhadoop.so

ADD ../nytaxi/target/spark-azure-nytaxi-1.0-SNAPSHOT-jar-with-dependencies.jar /opt/spark/jars/spark-azure-nytaxi-1.0-SNAPSHOT.jar

ENTRYPOINT [ "/opt/entrypoint.sh" ]
